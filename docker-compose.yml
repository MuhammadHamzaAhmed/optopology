services:

  mongodb:
    image: mongo:7.0
    container_name: topology_mongodb
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=topology_pass
      - MONGO_INITDB_DATABASE=optopology
      - TZ=Asia/Riyadh
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      arbNetwork:
        ipv4_address: 192.168.10.19
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  optopology:
    image: cisco/python_custom:v1.0
    container_name: optopology
    depends_on:
      mongodb:
        condition: service_healthy
    restart: always
    working_dir: /usr/src/app
    environment:
      - TZ=Asia/Riyadh
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_USER=admin
      - MONGO_PASSWORD=topology_pass
      - MONGO_DB=optopology
    privileged: true
    ports:
      - "0.0.0.0:5017:5017"
    networks:
      arbNetwork:
        ipv4_address: 192.168.10.10
    volumes:
      - ./optopology/src:/usr/src/app:Z
      - ./optopology/logs:/usr/src/applogs:Z
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request,sys; sys.exit(0) if urllib.request.urlopen(\"http://127.0.0.1:5017/topology-api/health-check\", timeout=2).getcode()==200 else sys.exit(1)'" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  frontend:
    build:
      context: ./frontend
      args:
        API_BASE: /api
    container_name: angular_nginx
    restart: unless-stopped
    depends_on:
      optopology:
        condition: service_healthy
    ports:
      - "3007:80"
    networks:
      - arbNetwork
    volumes:
      - ./Frontend/src:/app/src:Z


networks:
  arbNetwork:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.10.0/24

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
